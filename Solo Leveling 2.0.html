<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo Leveling: Despertar das Sombras</title>
    <style>
        /* (mesmo CSS anterior) */
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            margin: 0;
            min-height: 100vh;
            background: #1a0b2e;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        .stars-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, #4b0082, #0f001f);
            z-index: -1;
        }
        .stars-bg::before, .stars-bg::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            background-image: radial-gradient(2px 2px at 10px 20px, #fff, rgba(0,0,0,0)),
                              radial-gradient(2px 2px at 30px 60px, #f8f, rgba(0,0,0,0)),
                              radial-gradient(2px 2px at 50px 150px, #b6f, rgba(0,0,0,0)),
                              radial-gradient(2px 2px at 120px 80px, #fff, rgba(0,0,0,0)),
                              radial-gradient(3px 3px at 200px 300px, #e0b0ff, rgba(0,0,0,0)),
                              radial-gradient(2px 2px at 400px 150px, #c0a0ff, rgba(0,0,0,0)),
                              radial-gradient(4px 4px at 600px 500px, #d8b8ff, rgba(0,0,0,0)),
                              radial-gradient(3px 3px at 800px 200px, #ffffff, rgba(0,0,0,0)),
                              radial-gradient(2px 2px at 900px 700px, #f0e0ff, rgba(0,0,0,0));
            background-repeat: repeat;
            background-size: 200px 200px;
            opacity: 0.6;
            animation: twinkle 4s infinite alternate;
        }
        .stars-bg::after {
            background-size: 300px 300px;
            opacity: 0.4;
            animation: twinkle 6s infinite alternate-reverse;
        }
        @keyframes twinkle {
            0% { opacity: 0.2; }
            100% { opacity: 0.9; }
        }
        #gameContainer {
            width: 1200px;
            max-width: 95vw;
            height: 800px;
            max-height: 90vh;
            background: rgba(20, 5, 40, 0.8);
            backdrop-filter: blur(6px);
            border: 2px solid #a55aff;
            border-radius: 30px;
            box-shadow: 0 0 40px #9f4fdf;
            padding: 20px;
            color: #f0e6ff;
            z-index: 10;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .hidden {
            display: none !important;
        }
        #startScreen {
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #startScreen h1 {
            font-size: 5rem;
            text-shadow: 0 0 20px #b300ff, 0 0 40px #7700ff;
            margin-bottom: 10px;
            letter-spacing: 5px;
        }
        .criador {
            font-size: 1.8rem;
            color: #ffd966;
            text-shadow: 0 0 15px #b266ff;
            margin-bottom: 40px;
            display: inline-block;
        }
        .surgir-btn {
            background: linear-gradient(145deg, #6a1f9e, #38006b);
            border: 3px solid #ca9eff;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            padding: 20px 60px;
            border-radius: 60px;
            cursor: pointer;
            box-shadow: 0 0 30px #b76eff;
            transition: 0.2s;
            text-transform: uppercase;
        }
        .surgir-btn:hover {
            transform: scale(1.1);
            background: #8a2be2;
            box-shadow: 0 0 50px #d4a1ff;
        }
        #creationScreen {
            justify-content: center;
            align-items: center;
        }
        .creation-box {
            background: rgba(48, 12, 70, 0.9);
            padding: 40px;
            border-radius: 40px;
            border: 2px solid #b77eff;
            width: 500px;
            max-width: 90%;
            text-align: center;
        }
        .creation-box h2 {
            font-size: 2.5rem;
            margin-bottom: 30px;
        }
        .creation-box label {
            font-size: 1.5rem;
            display: block;
            margin: 20px 0 10px;
        }
        .creation-box input {
            background: #2e1047;
            border: 2px solid #a155e0;
            color: white;
            font-size: 1.4rem;
            padding: 8px 20px;
            border-radius: 40px;
            width: 80%;
            margin-bottom: 20px;
        }
        .surgir-small {
            font-size: 2rem;
            padding: 10px 40px;
            margin-top: 20px;
        }
        #gameScreen {
            flex-direction: row;
            gap: 15px;
        }
        #mapPanel {
            width: 30%;
            background: rgba(25, 5, 45, 0.9);
            border-radius: 30px;
            padding: 15px;
            border: 2px solid #b471ff;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        #mapPanel h3 {
            text-align: center;
            font-size: 2rem;
            margin: 0 0 10px;
            border-bottom: 2px solid #b77eff;
        }
        .area-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
        }
        .area-card {
            background: #341d4e;
            border-radius: 20px;
            padding: 10px;
            border: 2px solid #9f6fe0;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
        }
        .area-card:hover {
            background: #5b2e8a;
            border-color: #e5b2ff;
        }
        .area-card.selected {
            background: #7b3fb0;
            border-color: #ffd966;
        }
        .area-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(0.8);
        }
        .area-card.locked:hover {
            background: #341d4e;
            border-color: #9f6fe0;
        }
        .area-name {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .area-desc {
            font-size: 1.2rem;
        }
        .area-req {
            font-size: 1rem;
            color: #ffaa00;
            margin-top: 5px;
        }
        #enemyList {
            background: #221134;
            border-radius: 20px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 5px;
        }
        .enemy-entry {
            background: #442b63;
            margin: 5px 0;
            padding: 8px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            border: 1px solid #aa88ff;
            cursor: pointer;
        }
        .enemy-entry:hover {
            background: #6d44a3;
        }
        #infoPanel {
            width: 45%;
            background: rgba(30, 10, 50, 0.9);
            border-radius: 30px;
            padding: 15px;
            border: 2px solid #b471ff;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        /* Painel de estat√≠sticas */
        #playerStats {
            background: #221134;
            border-radius: 20px;
            padding: 15px;
            font-size: 1.2rem;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .stat-item {
            background: #2e154a;
            border-radius: 12px;
            padding: 8px 12px;
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #9f6fe0;
        }
        .stat-value {
            font-weight: bold;
            color: #ffd966;
            font-size: 1.4rem;
        }
        #statGemas {
            color: #ffaa00;
            font-size: 1.6rem;
        }
        #xpBarContainer {
            background: #0d0321;
            border-radius: 20px;
            padding: 8px;
            margin-top: 5px;
        }
        #xpBarLabel {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }
        #xpBarFill {
            height: 16px;
            background: linear-gradient(90deg, #8a2be2, #b266ff);
            border-radius: 20px;
            width: 0%;
            transition: width 0.3s;
        }
        #logArea {
            background: #0d0321;
            border-radius: 20px;
            padding: 15px;
            height: 150px;
            overflow-y: auto;
            font-size: 1.2rem;
            border: 1px solid #b28aff;
        }
        #combatActions, #shadowRecruit {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .btn {
            background: #4a2a6b;
            border: 2px solid #c69cff;
            color: white;
            font-size: 1.3rem;
            padding: 8px 20px;
            border-radius: 40px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .btn:hover:not(:disabled) {
            background: #7a4fb3;
            border-color: #f2daff;
        }
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        #rightPanel {
            width: 25%;
            background: rgba(25, 5, 45, 0.9);
            border-radius: 30px;
            padding: 15px;
            border: 2px solid #b471ff;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }
        #shadowList {
            background: #1f0a33;
            border-radius: 20px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .shadow-item {
            background: #371d52;
            margin: 5px 0;
            padding: 8px;
            border-radius: 12px;
            border: 1px solid #ad73e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .shadow-info {
            display: flex;
            flex-direction: column;
        }
        .shadow-name {
            font-weight: bold;
        }
        .shadow-bonus {
            font-size: 0.8rem;
            color: #aaffaa;
        }
        .btn-vender {
            background: #8b0000;
            border: 1px solid #ff6666;
            color: white;
            font-size: 0.9rem;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
        }
        .btn-vender:hover {
            background: #b30000;
        }
        .shop-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .shop-tab {
            flex: 1;
            background: #2d1545;
            border: 2px solid #b471ff;
            border-radius: 20px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .shop-tab.active {
            background: #7b3fb0;
            border-color: #ffd966;
        }
        .shop-panel {
            background: #2d1545;
            border-radius: 20px;
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        .shop-panel.active {
            display: block;
        }
        .equip-slot {
            background: #1e0b2e;
            margin: 10px 0;
            padding: 8px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .slot-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2e154a;
            padding: 5px;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        .item-info {
            font-size: 0.9rem;
            flex: 1;
        }
        .btn-equip, .btn-contratar, .btn-comprar-pocao, .btn-comprar-gemas {
            font-size: 0.9rem;
            padding: 4px 10px;
            min-width: 100px;
        }
        #companionList {
            max-height: 200px;
            overflow-y: auto;
        }
        .companion-item {
            background: #1e0b2e;
            margin: 5px 0;
            padding: 8px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .companion-info {
            flex: 1;
        }
        .companion-name {
            font-weight: bold;
        }
        .companion-details {
            font-size: 0.8rem;
            color: #aaffaa;
        }
        #gemsDisplay {
            font-size: 1.6rem;
            color: #ffd966;
            text-align: center;
        }
        #btnSubirRanking {
            width: 100%;
            margin-top: 10px;
            background: #9b4dff;
            border-color: #ffcc66;
        }
        #btnLojaGemas {
            width: 100%;
            margin-bottom: 10px;
            background: #ffaa00;
            border-color: #ffd966;
            color: #1a0b2e;
        }
        #potionStatus {
            background: #1e0b2e;
            border-radius: 20px;
            padding: 8px;
            text-align: center;
            border: 1px solid #ffaa00;
        }
        #potionButtons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-top: 5px;
        }
        .potion-btn {
            background: #008b8b;
            border: 1px solid #66ffff;
            color: white;
            font-size: 0.8rem;
            padding: 4px 6px;
            border-radius: 12px;
            cursor: pointer;
        }
        .potion-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        #dungeonPrompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d1545;
            border: 3px solid #ffd966;
            border-radius: 30px;
            padding: 30px;
            text-align: center;
            z-index: 100;
            box-shadow: 0 0 50px #000;
        }
        #dungeonPrompt h2 {
            margin-top: 0;
            color: #ffd966;
        }
        #dungeonPrompt button {
            margin: 10px;
            font-size: 2rem;
        }
        /* Estilo para o timer de valida√ß√£o */
        #pixTimer {
            color: #ffaa00;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="stars-bg"></div>
<div id="gameContainer">
    <!-- TELA INICIAL -->
    <div id="startScreen" class="screen">
        <h1>SOLO LEVELING</h1>
        <div class="criador">Renan Vinicius A. G. da Silva</div>
        <button class="surgir-btn" id="btnSurgirInicial">SURGIR</button>
    </div>

    <!-- TELA DE CRIA√á√ÉO -->
    <div id="creationScreen" class="screen hidden">
        <div class="creation-box">
            <h2>‚ú® DESPERTAR ‚ú®</h2>
            <label>NOME DO CA√áADOR</label>
            <input type="text" id="playerName" maxlength="20" placeholder="Digite seu nome">
            <button class="surgir-btn surgir-small" id="btnIniciarJogo">SURGIR</button>
        </div>
    </div>

    <!-- TELA PRINCIPAL DO JOGO -->
    <div id="gameScreen" class="screen hidden">
        <!-- MAPA (esquerda) -->
        <div id="mapPanel">
            <h3>üè∞ MASMORRAS</h3>
            <div class="area-list" id="dungeonList"></div>
        </div>

        <!-- INFO CENTRAL -->
        <div id="infoPanel">
            <div id="playerStats">
                <div class="stat-row">
                    <div class="stat-item">HP <span class="stat-value"><span id="statHp">0</span>/<span id="statMaxHp">0</span></span></div>
                    <div class="stat-item">MP <span class="stat-value" id="statMana">0</span></div>
                </div>
                <div class="stat-row">
                    <div class="stat-item">STR <span class="stat-value" id="statForca">0</span></div>
                    <div class="stat-item">VIT <span class="stat-value" id="statVit">0</span></div>
                </div>
                <div class="stat-row">
                    <div class="stat-item">PONTOS <span class="stat-value" id="statPontos">0</span></div>
                    <div class="stat-item">GEMAS <span class="stat-value" id="statGemas">0</span></div>
                </div>
                <div id="xpBarContainer">
                    <div id="xpBarLabel">
                        <span>XP</span>
                        <span id="xpText">0/100</span>
                    </div>
                    <div id="xpBarFill" style="width:0%"></div>
                </div>
            </div>
            <div id="logArea">[Sistema] Bem-vindo ao jogo. Escolha uma masmorra.</div>
            <div id="enemyList"><div style="text-align:center;">Selecione uma masmorra</div></div>
            <div id="combatActions" class="hidden">
                <button class="btn" id="btnAtacar">‚öîÔ∏è Atacar</button>
                <button class="btn" id="btnFugir">üèÉ Fugir</button>
            </div>
            <div id="shadowRecruit" class="hidden">
                <button class="btn" id="btnTornarSombra">üë§ Tornar Sombra (3 tent.)</button>
                <button class="btn" id="btnEliminar">üíÄ Eliminar</button>
            </div>
            <div id="levelUpActions" class="hidden">
                <button class="btn" id="btnForca">+For√ßa</button>
                <button class="btn" id="btnMana">+Mana</button>
                <button class="btn" id="btnVida">+Vida</button>
            </div>
            <div id="companionStatus" class="hidden">
                <h4>üë• COMPANHEIROS NA MASMORRA</h4>
                <div id="activeCompanions"></div>
            </div>
            <!-- Status da po√ß√£o -->
            <div id="potionStatus" class="hidden">
                <span>Po√ß√µes:</span>
                <div id="potionButtons"></div>
            </div>
        </div>

        <!-- PAINEL DIREITO -->
        <div id="rightPanel">
            <!-- Bot√£o Loja de Gemas (substitui o antigo bot√£o de ranking) -->
            <button id="btnLojaGemas" class="btn">üíé LOJA DE GEMAS</button>
            
            <div id="gemsDisplay">üíé 0</div>
            
            <div>
                <div class="shop-tabs">
                    <div class="shop-tab active" data-shop="equip">üõ°Ô∏è Equip.</div>
                    <div class="shop-tab" data-shop="companion">üë• Cias.</div>
                    <div class="shop-tab" data-shop="potion">üß™ Po√ß√µes</div>
                    <div class="shop-tab" data-shop="gemshop">üíé Gemas</div>
                </div>
                
                <div id="shopEquip" class="shop-panel active">
                    <div id="shopPanel"></div>
                </div>
                
                <div id="shopCompanion" class="shop-panel">
                    <h4>üìú CONTRATAR COMPANHEIROS</h4>
                    <div id="companionShopList"></div>
                    <div id="companionList"></div>
                </div>
                
                <div id="shopPotion" class="shop-panel">
                    <h4>üß™ PO√á√ïES DE VIDA</h4>
                    <div class="item-row">
                        <span class="item-info">Po√ß√£o Pequena (cura 10%)</span>
                        <button class="btn-comprar-pocao" data-tipo="10">Comprar (üíé1000)</button>
                    </div>
                    <div class="item-row">
                        <span class="item-info">Po√ß√£o M√©dia (cura 25%)</span>
                        <button class="btn-comprar-pocao" data-tipo="25">Comprar (üíé2500)</button>
                    </div>
                    <div class="item-row">
                        <span class="item-info">Po√ß√£o Grande (cura 50%)</span>
                        <button class="btn-comprar-pocao" data-tipo="50">Comprar (üíé5000)</button>
                    </div>
                    <div class="item-row">
                        <span class="item-info">Po√ß√£o Superior (cura 75%)</span>
                        <button class="btn-comprar-pocao" data-tipo="75">Comprar (üíé7500)</button>
                    </div>
                    <div class="item-row">
                        <span class="item-info">Po√ß√£o Total (cura 100%)</span>
                        <button class="btn-comprar-pocao" data-tipo="100">Comprar (üíé10000)</button>
                    </div>
                </div>

                <!-- Nova aba: Loja de Gemas (comprar com dinheiro real) -->
                <div id="shopGems" class="shop-panel">
                    <h4>üíé COMPRAR GEMAS</h4>
                    <div class="item-row">
                        <span class="item-info">100 Gemas</span>
                        <button class="btn-comprar-gemas" data-gemas="100" data-preco="1">R$ 1,00</button>
                    </div>
                    <div class="item-row">
                        <span class="item-info">500 Gemas</span>
                        <button class="btn-comprar-gemas" data-gemas="500" data-preco="5">R$ 5,00</button>
                    </div>
                    <div class="item-row">
                        <span class="item-info">1200 Gemas</span>
                        <button class="btn-comprar-gemas" data-gemas="1200" data-preco="10">R$ 10,00</button>
                    </div>
                    <div class="item-row">
                        <span class="item-info">2500 Gemas</span>
                        <button class="btn-comprar-gemas" data-gemas="2500" data-preco="20">R$ 20,00</button>
                    </div>
                    <div class="item-row">
                        <span class="item-info">6500 Gemas</span>
                        <button class="btn-comprar-gemas" data-gemas="6500" data-preco="50">R$ 50,00</button>
                    </div>
                    <div class="item-row">
                        <span class="item-info">14000 Gemas</span>
                        <button class="btn-comprar-gemas" data-gemas="14000" data-preco="100">R$ 100,00</button>
                    </div>
                </div>
            </div>
            
            <div>
                <h4>üë• SOMBRAS (<span id="shadowCount">0</span>/<span id="maxShadow">0</span>)</h4>
                <div id="shadowList"></div>
            </div>

            <!-- Bot√£o SUBIR RANKING movido para a parte inferior central -->
            <button id="btnSubirRanking" class="btn">‚¨ÜÔ∏è SUBIR RANKING</button>
        </div>
    </div>
    <!-- Di√°logo de confirma√ß√£o de masmorra -->
    <div id="dungeonPrompt" class="hidden">
        <h2 id="promptDungeonName"></h2>
        <p>Iniciar esta masmorra?</p>
        <button class="btn" id="promptConfirm">‚öîÔ∏è SURGIR</button>
        <button class="btn" id="promptCancel">‚ùå Ainda n√£o</button>
    </div>
    <!-- Di√°logo de compra de gemas (simples, usaremos confirm e alert) -->
</div>

<script>
(function() {
    // ---------- CAT√ÅLOGO DE ITENS ----------
    const itemCatalog = {
        cabeca: [
            { id: 'capacete_couro', nome: 'Capacete de Couro RANK(E)', hp: 2, preco: 5 },
            { id: 'elmo_ferro', nome: 'Elmo de Ferro RANK(D)', hp: 20, preco: 35 },
            { id: 'capacete_espinhos', nome: 'Capacete de Espinho RANK(C)', hp: 62, forca: 130, preco: 85 },
            { id: 'coroa_mana', nome: 'Coroa de Mana RANK(E)', mana: 10, preco: 15 },
            { id: 'capacete_betinha', nome: 'Capacete Betinha RANK(C)', hp: 230, preco: 160 },
            { id: 'capacete_de_ferro', nome: 'Capacete de Ferro RANK(B)', hp: 500, preco: 410 },
            { id: 'capacete_de_ouro', nome: 'Capacete de Ouro RANK(A)', hp: 750, preco: 820 },
            { id: 'coroa_das_sombras', nome: 'Coroa das Sombras RANK(S)', mana: 80, preco: 6700 }
        ],
        maoD: [
            { id: 'adaga', nome: 'Adaga RANK(E)', forca: 7, preco: 5 },
            { id: 'espada_curta', nome: 'Espada Curta RANK(D)', forca: 20, preco: 35 },
            { id: 'espada_longa', nome: 'Espada Longa RANK(D)', forca: 50, preco: 70 },
            { id: 'cajado', nome: 'Cajado RANK(S)', mana: 80, preco: 7030 },
            { id: 'lan√ßa', nome: 'Lan√ßa RANK(C)', forca: 130, preco: 240 },
            { id: 'maca_de_espinhos', nome: 'Ma√ß√£ de Espinhos RANK(B)', forca: 260, preco: 550 },
            { id: 'espada_de_sombras', nome: 'Espada de Sombras RANK(A)', forca: 670, preco: 700 },
            { id: 'foice_da_morte', nome: 'Foice da Morte RANK(S)', forca: 5000, preco: 2500 }
        ],
        maoE: [
            { id: 'escudo_madeira', nome: 'Escudo de Madeira RANK(E)', hp: 8, preco: 24 },
            { id: 'luva_sombra', nome: 'Luva de Sombra(S+)', mana: 120, preco: 12018 },
            { id: 'amuleto', nome: 'Amuleto RANK(C)', mana: 12, preco: 528 },
            { id: 'escudo_espinho', nome: 'Escudo de Espinho RANK(B)', hp: 126, forca:239, preco: 522 },
            { id: 'escudo_pedra', nome: 'Escudo de Pedra RANK(D)', hp: 120, preco: 202 },
            { id: 'escudo_ferro', nome: 'Escudo de Ferro RANK(A)', hp: 760, preco: 800 },
            { id: 'escudo_ouro', nome: 'Escudo de Ouro RANK(A)', hp: 600, preco: 860},
        ],
        tronco: [
            { id: 'armadura_couro', nome: 'Armadura de Couro RANK(E)', hp: 10, preco: 20 },
            { id: 'peitoral_aco', nome: 'Peitoral de A√ßo RANK(S)', hp: 2000, preco: 1570 },
            { id: 'peitoral_espinho', nome: 'Peitoral de Espinho RANK(B)', hp: 386, forca: 340, preco: 640 },
            { id: 'tunica', nome: 'Tunica RANK(B)', mana: 40, preco: 1030 },
            { id: 'cota_malha', nome: 'Cota de Malha RANK(D)', hp: 58, forca: 20, preco: 170 },
            { id: 'peitoral_brigantina', nome: 'Peitoral de Brigantina RANK(C)', hp: 400, preco: 320 },
            { id: 'peitoral_ferro', nome: 'Peitoral de Ferro RANK(A)', hp: 858, preco: 900 }
        ],
        pernas: [
            { id: 'grevas_couro', nome: 'Grevas de Couro RANK(D)', hp: 47, preco: 65 },
            { id: 'calca_tecido', nome: 'Cal√ßa de Tecido RANK(E)', hp: 3, preco: 5 },
            { id: 'chausses_cota_de_malha', nome: 'Chausses de Cota de Malha RANK(C)', hp: 139, preco: 130 },
            { id: 'grevas_aco', nome: 'Grevas de Placa de A√ßo RANK(B)', hp: 373, preco: 420 },
            { id: 'armadura_placas', nome: 'Armadura de Placas RANK(A)', hp: 720, preco: 765 },
            { id: 'grevas_monarca', nome: 'Grevas do Monarca RANK(S)', mana: 60, preco: 3000 }
        ]
    };

    // ---------- CAT√ÅLOGO DE COMPANHEIROS ----------
    const companionCatalog = [
        // Rank E
        { id: 'han_songyi_e', nome: 'Han Song-Yi', rank: 'E', classe: 'Mage', preco: 30,
          desc: 'Estudante rank-E, sonha ser hunter mas √© inexperiente',
          forca: 5, mana: 15, hp: 50 },
        { id: 'yoo_jinho_base', nome: 'Yoo Jinho (Base)', rank: 'E', classe: 'Tanker', preco: 35,
          desc: 'Herdeiro da Yoojin Construction, leal mas sem experi√™ncia',
          forca: 8, mana: 5, hp: 80 },
        
        // Rank D
        { id: 'ju_hee', nome: 'Ju-Hee', rank: 'D', classe: 'Healer', preco: 60,
          desc: 'Healer B-rank que se aposentou ap√≥s trauma',
          forca: 2, mana: 25, hp: 40 },
        { id: 'song_chi_yul', nome: 'Song Chi-Yul', rank: 'D', classe: 'Mage', preco: 70,
          desc: 'Professor de kumdo, perdeu o bra√ßo no Double Dungeon',
          forca: 10, mana: 20, hp: 70 },
        { id: 'yoo_jinho_armor', nome: 'Yoo Jinho (Armadura Lend√°ria)', rank: 'D', classe: 'Tanker', preco: 85,
          desc: 'Equipado com armadura cara, mais resistente',
          forca: 15, mana: 8, hp: 150 },
        
        // Rank C
        { id: 'hwang_dongsuk', nome: 'Hwang Dongsuk', rank: 'C', classe: 'Tanker', preco: 120,
          desc: 'L√≠der de esquadr√£o, cruel e interesseiro',
          forca: 25, mana: 5, hp: 200 },
        { id: 'park_beom_shik', nome: 'Park Beom-Shik', rank: 'C', classe: 'Fighter', preco: 110,
          desc: 'Mercen√°rio que busca dinheiro f√°cil',
          forca: 30, mana: 5, hp: 150 },
        { id: 'cho_kyu_hwan', nome: 'Cho Kyu-Hwan', rank: 'C', classe: 'Mage', preco: 100,
          desc: 'Mago do esquadr√£o de Dongsuk',
          forca: 10, mana: 35, hp: 80 },
        
        // Rank B
        { id: 'kang_taeshik', nome: 'Kang Taeshik', rank: 'B', classe: 'Assassin', preco: 200,
          desc: 'Agente corrupto que matava criminosos, cruel',
          forca: 45, mana: 10, hp: 180 },
        { id: 'kim_chul', nome: 'Kim Chul', rank: 'B', classe: 'Tanker', preco: 190,
          desc: 'Tank da White Tiger, confiante mas arrogante',
          forca: 30, mana: 5, hp: 300 },
        { id: 'park_heejin', nome: 'Park Heejin', rank: 'B', classe: 'Mage', preco: 180,
          desc: 'Maga com instintos de sobreviv√™ncia agu√ßados',
          forca: 15, mana: 40, hp: 120 },
        { id: 'han_songyi_b', nome: 'Han Song-Yi (Treinada)', rank: 'B', classe: 'Mage', preco: 170,
          desc: 'Vers√£o mais experiente ap√≥s incidentes',
          forca: 15, mana: 35, hp: 100 },
        
        // Rank A
        { id: 'woo_jinchul', nome: 'Woo Jinchul', rank: 'A', classe: 'Tanker', preco: 350,
          desc: 'Inspetor da Associa√ß√£o, for√ßa quase S-rank',
          forca: 50, mana: 15, hp: 350 },
        { id: 'kim_chul_a', nome: 'Kim Chul (A-rank)', rank: 'A', classe: 'Tanker', preco: 320,
          desc: 'Vers√£o mais forte, estrela da White Tiger',
          forca: 60, mana: 8, hp: 450 },
        { id: 'yoo_soohyun', nome: 'Yoo Soohyun', rank: 'A', classe: 'Mage', preco: 300,
          desc: 'Maga de alto n√≠vel, irm√£ de Jinho',
          forca: 20, mana: 60, hp: 150 },
        
        // Rank S
        { id: 'cha_hae_in', nome: 'Cha Hae-In', rank: 'S', classe: 'Fighter', preco: 800,
          desc: 'Vice-mestra da Hunters Guild, for√ßa excepcional',
          forca: 120, mana: 40, hp: 500 },
        { id: 'choi_jong_in', nome: 'Choi Jong-In', rank: 'S', classe: 'Mage', preco: 750,
          desc: 'Mestre da Hunters Guild, "O Hunter Supremo"',
          forca: 30, mana: 120, hp: 300 },
        { id: 'baek_yoonho', nome: 'Baek Yoonho', rank: 'S', classe: 'Tanker', preco: 780,
          desc: 'Mestre da White Tiger, pode se transformar',
          forca: 100, mana: 20, hp: 600 },
        { id: 'hwang_dongsoo', nome: 'Hwang Dong-Su', rank: 'S', classe: 'Fighter', preco: 820,
          desc: 'Hunter S que traiu a Coreia, extremamente forte',
          forca: 130, mana: 25, hp: 550 },
        { id: 'go_gunhee', nome: 'Go Gunhee', rank: 'S', classe: 'Mage', preco: 700,
          desc: 'Presidente da Associa√ß√£o, poder dos Rulers',
          forca: 40, mana: 100, hp: 250 },
        
        // Rank S+ (National Level)
        { id: 'sung_jinwoo', nome: 'Sung Jinwoo (Monarca)', rank: 'S+', classe: 'Fighter', preco: 2000,
          desc: 'O Monarca das Sombras, poder absoluto',
          forca: 300, mana: 200, hp: 1200 },
        { id: 'thomas_andre', nome: 'Thomas Andre', rank: 'S+', classe: 'Tanker', preco: 1800,
          desc: 'National Level Hunter #1, "Golias"',
          forca: 250, mana: 50, hp: 1500 },
        { id: 'liu_zhigang', nome: 'Liu Zhigang', rank: 'S+', classe: 'Fighter', preco: 1750,
          desc: 'National Level Hunter #2, mais forte da China',
          forca: 280, mana: 60, hp: 1100 },
        { id: 'christopher_reed', nome: 'Christopher Reed', rank: 'S+', classe: 'Mage', preco: 1700,
          desc: 'National Level Hunter #3, poder m√°gico imenso',
          forca: 50, mana: 250, hp: 800 }
    ];

    // B√¥nus base por rank de sombra (valor por n√≠vel)
    const shadowBaseBonus = {
        'E': { forca: 5, hp: 25 },
        'D': { forca: 10, hp: 50 },
        'C': { forca: 20, hp: 100 },
        'B': { forca: 40, hp: 200 },
        'A': { forca: 80, hp: 400 },
        'S': { forca: 160, hp: 800 },
        'S+': { forca: 320, hp: 1600 }
    };

    // Pre√ßo base de venda das sombras
    const shadowBasePrice = {
        'E': 10,
        'D': 30,
        'C': 90,
        'B': 270,
        'A': 810,
        'S': 2430,
        'S+': 7290
    };

    // ---------- ESTADO GLOBAL ----------
    let player = {
        name: '',
        level: 1,
        xp: 0,
        xpNext: 100,
        rank: 'E',
        gems: 50,
        base: {
            forca: 10,
            mana: 0,
            maxHp: 100
        },
        hp: 100,
        shadows: [],
        equipment: {
            cabeca: null,
            maoD: null,
            maoE: null,
            tronco: null,
            pernas: null
        },
        inventario: [],
        pontosStatus: 0,
        companions: [],
        currentDungeonRank: null,
        potions: { '10': 0, '25': 0, '50': 0, '75': 0, '100': 0 }
    };

    // Totais calculados
    let totalForca = player.base.forca;
    let totalMana = player.base.mana;
    let totalMaxHp = player.base.maxHp;

    // Multiplicadores de rank (base 5, exponencial)
    const rankMultiplier = {
        'E': 1,
        'D': 5,
        'C': 25,
        'B': 125,
        'A': 625,
        'S': 3125,
        'S+': 15625
    };

    // Vari√°vel para controlar se a masmorra atual foi completada
    let dungeonComplete = false;

    // ---------- MASMORRAS (igual ao anterior) ----------
    const dungeons = [
        {
            nome: 'üåæ Plan√≠cie dos Goblins',
            bossRank: 'E',
            mobs: [
                { nome: 'Goblin Rasteiro', rank: 'E' },
                { nome: 'Goblin Guerreiro', rank: 'E' }
            ],
            boss: { nome: 'Chefe Goblin', rank: 'E' }
        },
        {
            nome: 'üêç Caverna de Kasaka',
            bossRank: 'D',
            mobs: [
                { nome: 'Cobra Venenosa', rank: 'E' },
                { nome: 'Cobra Gigante', rank: 'E' }
            ],
            boss: { nome: 'Kasaka', rank: 'D' }
        },
        {
            nome: 'üå≤ Floresta dos Licantropos',
            bossRank: 'C',
            mobs: [
                { nome: 'Lobo Sombrio', rank: 'D' },
                { nome: 'Esqueleto Guerreiro', rank: 'D' },
                { nome: 'Aranha Gigante', rank: 'D' }
            ],
            boss: { nome: 'Licantropo Alfa', rank: 'C' }
        },
        {
            nome: '‚ùÑÔ∏è Tundra de Gel',
            bossRank: 'B',
            mobs: [
                { nome: 'Urso de Gelo Filhote', rank: 'C' },
                { nome: 'Centop√©ia de Gelo', rank: 'C' },
                { nome: 'Yeti', rank: 'C' }
            ],
            boss: { nome: 'Urso de Gelo Ancestral', rank: 'B' }
        },
        {
            nome: 'üî• Fortaleza do Vulc√£o',
            bossRank: 'A',
            mobs: [
                { nome: 'Orc Vermelho', rank: 'B' },
                { nome: 'Mago Orc', rank: 'B' },
                { nome: 'Golem de Lava', rank: 'B' }
            ],
            boss: { nome: 'Vulcan', rank: 'A' }
        },
        {
            nome: 'üè∞ Castelo de Igris',
            bossRank: 'S',
            mobs: [
                { nome: 'Cavaleiro Negro', rank: 'A' },
                { nome: 'Cavaleiro de Elite', rank: 'A' },
                { nome: 'Feiticeiro das Sombras', rank: 'A' },
                { nome: 'Guerreiro Esqueleto', rank: 'A' }
            ],
            boss: { nome: 'Igris', rank: 'S' }
        },
        {
            nome: 'üëë Trono de Kamish',
            bossRank: 'S+',
            mobs: [
                { nome: 'Beru', rank: 'S' },
                { nome: 'Bellion', rank: 'S' },
                { nome: 'Comandante das Sombras', rank: 'S' }
            ],
            boss: { nome: 'Kamish, o Destruidor', rank: 'S+' }
        },
        // Novas masmorras
        {
            nome: 'üï∑Ô∏è Toca da Aranha Gigante',
            bossRank: 'C',
            mobs: [
                { nome: 'Aranha Pequena', rank: 'E' },
                { nome: 'Aranha Venenosa', rank: 'D' }
            ],
            boss: { nome: 'Rainha Aranha', rank: 'C' }
        },
        {
            nome: '‚ö∞Ô∏è Cripta do Cavaleiro da Morte',
            bossRank: 'A',
            mobs: [
                { nome: 'Esqueleto Guerreiro', rank: 'B' },
                { nome: 'Cavaleiro Espectral', rank: 'B' },
                { nome: 'Lich Menor', rank: 'B' }
            ],
            boss: { nome: 'Cavaleiro da Morte', rank: 'A' }
        },
        {
            nome: 'üèîÔ∏è Pico do Drag√£o de Gelo',
            bossRank: 'S',
            mobs: [
                { nome: 'Draconiano', rank: 'A' },
                { nome: 'Elemental de Gelo', rank: 'A' },
                { nome: 'Gigante de Gelo', rank: 'A' }
            ],
            boss: { nome: 'Drag√£o de Gelo', rank: 'S' }
        },
        {
            nome: 'üåã Cratera do Tit√£',
            bossRank: 'B',
            mobs: [
                { nome: 'Elemental de Fogo', rank: 'C' },
                { nome: 'Golem de Rocha', rank: 'C' },
                { nome: 'Salamandra', rank: 'C' }
            ],
            boss: { nome: 'Tit√£ de Pedra', rank: 'B' }
        },
        {
            nome: 'üåë Templo das Sombras',
            bossRank: 'S+',
            mobs: [
                { nome: 'Sombra Espectral', rank: 'S' },
                { nome: 'Cavaleiro Sombrio', rank: 'S' }
            ],
            boss: { nome: 'Monarca das Sombras', rank: 'S+' }
        }
    ];

    function gerarInimigosDungeon(dungeonIdx) {
        let dungeon = dungeons[dungeonIdx];
        let lista = [];
        let bossMult = rankMultiplier[dungeon.bossRank];
        
        dungeon.mobs.forEach((mob, i) => {
            let mult = rankMultiplier[mob.rank];
            let hp = 30 * mult * (1 + i * 0.1);
            let forca = 5 * mult * (1 + i * 0.1);
            let xp = 20 * mult;
            let gem = 5 * mult;
            lista.push({
                nome: mob.nome,
                rank: mob.rank,
                hp: Math.floor(hp),
                maxHp: Math.floor(hp),
                forca: Math.floor(forca),
                xp: Math.floor(xp),
                gem: Math.floor(gem),
                vivo: true,
                isBoss: false
            });
        });
        
        let bossHp = 30 * bossMult * 1.5;
        let bossForca = 5 * bossMult * 1.5;
        let bossXp = 20 * bossMult * 1.5;
        let bossGem = 5 * bossMult * 1.5;
        lista.push({
            nome: dungeon.boss.nome,
            rank: dungeon.boss.rank,
            hp: Math.floor(bossHp),
            maxHp: Math.floor(bossHp),
            forca: Math.floor(bossForca),
            xp: Math.floor(bossXp),
            gem: Math.floor(bossGem),
            vivo: true,
            isBoss: true
        });
        
        return lista;
    }

    let dungeonInstances = dungeons.map((d, idx) => ({
        nome: d.nome,
        rank: d.bossRank,
        inimigos: gerarInimigosDungeon(idx)
    }));

    function getShadowBonus(shadow) {
        let base = shadowBaseBonus[shadow.rank] || { forca: 0, hp: 0 };
        return {
            forca: base.forca * shadow.level,
            hp: base.hp * shadow.level
        };
    }

    function darXPSombras(xpGanho) {
        if (player.shadows.length === 0) return;
        let xpPorSombra = Math.floor(xpGanho / player.shadows.length);
        if (xpPorSombra < 1) xpPorSombra = 1;
        
        player.shadows.forEach(shadow => {
            shadow.xp += xpPorSombra;
            while (shadow.xp >= shadow.xpNext) {
                shadow.level++;
                shadow.xp -= shadow.xpNext;
                shadow.xpNext = Math.floor(shadow.xpNext * 1.5);
            }
        });
    }

    function recalcularTotais() {
        totalForca = player.base.forca;
        totalMana = player.base.mana;
        totalMaxHp = player.base.maxHp;

        for (let slot in player.equipment) {
            let itemId = player.equipment[slot];
            if (itemId) {
                let item = encontrarItemPorId(slot, itemId);
                if (item) {
                    totalForca += item.forca || 0;
                    totalMana += item.mana || 0;
                    totalMaxHp += item.hp || 0;
                }
            }
        }

        player.shadows.forEach(s => {
            let bonus = getShadowBonus(s);
            totalForca += bonus.forca;
            totalMaxHp += bonus.hp;
        });

        if (player.companions.length > 0 && player.currentDungeonRank) {
            player.companions.forEach(c => {
                totalForca += c.forca || 0;
                totalMana += c.mana || 0;
                totalMaxHp += c.hp || 0;
            });
        }

        if (player.hp > totalMaxHp) player.hp = totalMaxHp;
    }

    function encontrarItemPorId(slot, id) {
        return itemCatalog[slot].find(i => i.id === id);
    }

    function regenerarDungeonSeNecessario(dungeonIdx) {
        let dungeon = dungeonInstances[dungeonIdx];
        if (!dungeon) return;
        let todosMortos = dungeon.inimigos.every(inimigo => !inimigo.vivo);
        if (todosMortos) {
            player.hp = totalMaxHp;
            addLog('‚ú® Bom trabalho! Voc√™ completou a masmorra!');
            dungeonComplete = true;
            currentDungeonIdx = null;
            player.currentDungeonRank = null;
            player.companions = [];
            document.getElementById('companionStatus').classList.add('hidden');
            document.getElementById('potionStatus').classList.add('hidden');
        }
    }

    let currentDungeonIdx = null;
    let currentEnemyIndex = null;
    let inCombat = false;
    let recruitAttempts = 0;
    let isTestRank = false;

    function addLog(msg) {
        let log = document.getElementById('logArea');
        log.innerHTML += '<br>> ' + msg;
        log.scrollTop = log.scrollHeight;
    }

    function aplicarPenalidadeMorte() {
        player.gems = 0;
        player.inventario = [];
        for (let slot in player.equipment) {
            player.equipment[slot] = null;
        }
        player.companions = [];
        player.currentDungeonRank = null;
        addLog('üíî Voc√™ morreu! Perdeu todas as gemas e todos os itens.');
    }

    function aplicarPenalidadeFuga() {
        let perda = Math.max(1, Math.floor(player.gems * 0.2));
        player.gems = Math.max(0, player.gems - perda);
        player.companions = [];
        player.currentDungeonRank = null;
        addLog(`üèÉ Voc√™ fugiu! Perdeu ${perda} gemas e seus companheiros.`);
    }

    function contratarCompanheiro(companionId) {
        if (inCombat) {
            addLog('N√£o pode contratar durante combate.');
            return;
        }
        
        let companion = companionCatalog.find(c => c.id === companionId);
        if (!companion) return;
        
        if (player.companions.length >= 5) {
            addLog('Limite de 5 companheiros por masmorra atingido!');
            return;
        }
        
        if (player.gems < companion.preco) {
            addLog('Gemas insuficientes!');
            return;
        }
        
        player.gems -= companion.preco;
        player.companions.push({ ...companion });
        addLog(`‚úÖ Contratou ${companion.nome} (${companion.rank}) para esta masmorra.`);
        refreshUI();
    }

    function comprarPocao(tipo) {
        if (inCombat) {
            addLog('N√£o pode comprar durante combate.');
            return;
        }
        let preco = parseInt(tipo) === 10 ? 1000 : parseInt(tipo) === 25 ? 2500 : parseInt(tipo) === 50 ? 5000 : parseInt(tipo) === 75 ? 7500 : 10000;
        if (player.gems < preco) {
            addLog('Gemas insuficientes!');
            return;
        }
        player.gems -= preco;
        player.potions[tipo]++;
        addLog(`üß™ Voc√™ comprou uma Po√ß√£o de ${tipo}%.`);
        refreshUI();
    }

    function usarPocao(tipo) {
        if (inCombat) {
            addLog('N√£o pode usar po√ß√£o em combate.');
            return;
        }
        if (player.potions[tipo] <= 0) {
            addLog('Voc√™ n√£o tem po√ß√µes desse tipo!');
            return;
        }
        let cura = Math.floor(totalMaxHp * (parseInt(tipo) / 100));
        player.hp = Math.min(totalMaxHp, player.hp + cura);
        player.potions[tipo]--;
        addLog(`üß™ Voc√™ usou uma Po√ß√£o de ${tipo}% e curou ${cura} de vida.`);
        refreshUI();
    }

    // ---------- NOVA FUN√á√ÉO: COMPRAR GEMAS COM DINHEIRO REAL ----------
    function comprarGemas(gemas, preco) {
        if (inCombat) {
            addLog('N√£o pode comprar durante combate.');
            return;
        }
        // Confirmar compra
        if (!confirm(`Quer comprar ${gemas} gemas por R$ ${preco.toFixed(2)}?`)) {
            return;
        }
        // Mostrar c√≥digo PIX
        alert(`PIX copia e cola: 70472738402\n\nAguardando valida√ß√£o... (1 minuto)`);
        
        // Desabilitar bot√µes de compra durante o tempo de espera? (opcional)
        // Simular valida√ß√£o de 1 minuto
        addLog(`‚è≥ Processando compra de ${gemas} gemas... Aguarde 1 minuto.`);
        setTimeout(() => {
            // Adicionar gemas ao jogador
            player.gems += gemas;
            addLog(`‚úÖ Pagamento confirmado! Voc√™ recebeu ${gemas} gemas.`);
            refreshUI();
        }, 60000); // 60.000 ms = 1 minuto
    }

    function renderPotionButtons() {
        let div = document.getElementById('potionButtons');
        div.innerHTML = '';
        for (let tipo in player.potions) {
            if (player.potions[tipo] > 0) {
                let btn = document.createElement('button');
                btn.className = 'potion-btn';
                btn.innerText = `${tipo}% (${player.potions[tipo]})`;
                btn.onclick = () => usarPocao(tipo);
                div.appendChild(btn);
            }
        }
    }

    function renderCompanionShop() {
        let shopDiv = document.getElementById('companionShopList');
        let html = '<div class="equip-slot">';
        const ranks = ['E', 'D', 'C', 'B', 'A', 'S', 'S+'];
        ranks.forEach(rank => {
            let companionsRank = companionCatalog.filter(c => c.rank === rank);
            if (companionsRank.length > 0) {
                html += `<div class="slot-header">RANK ${rank}</div>`;
                companionsRank.forEach(c => {
                    html += `<div class="item-row">
                        <div class="item-info">
                            <strong>${c.nome}</strong> (${c.classe})<br>
                            <small>${c.desc}</small><br>
                            ‚öîÔ∏è${c.forca} üîÆ${c.mana} ‚ù§Ô∏è${c.hp}
                        </div>
                        <button class="btn-contratar" data-id="${c.id}">Contratar (üíé${c.preco})</button>
                    </div>`;
                });
            }
        });
        html += '</div>';
        shopDiv.innerHTML = html;
        
        document.querySelectorAll('.btn-contratar').forEach(btn => {
            btn.addEventListener('click', (e) => {
                let id = e.target.dataset.id;
                contratarCompanheiro(id);
            });
        });
    }

    function renderActiveCompanions() {
        let div = document.getElementById('activeCompanions');
        if (player.companions.length === 0) {
            div.innerHTML = '<p>Nenhum companheiro contratado</p>';
            return;
        }
        let html = '';
        player.companions.forEach(c => {
            html += `<div class="companion-item">
                <div class="companion-info">
                    <span class="companion-name">${c.nome} (${c.rank})</span>
                    <span class="companion-details">‚öîÔ∏è${c.forca} üîÆ${c.mana} ‚ù§Ô∏è${c.hp}</span>
                </div>
            </div>`;
        });
        div.innerHTML = html;
    }

    function renderDungeons() {
        let listDiv = document.getElementById('dungeonList');
        let html = '';
        
        dungeonInstances.forEach((dungeon, idx) => {
            let rankValue = rankMultiplier[player.rank] || 1;
            let dungeonRankValue = rankMultiplier[dungeon.rank] || 1;
            let isLocked = rankValue < dungeonRankValue;
            
            html += `<div class="area-card ${isLocked ? 'locked' : ''}" data-dungeon="${idx}">
                <div class="area-name">${dungeon.nome}</div>
                <div class="area-desc">Rank necess√°rio: ${dungeon.rank}</div>
                ${isLocked ? '<div class="area-req">üîí Rank insuficiente</div>' : ''}
            </div>`;
        });
        
        listDiv.innerHTML = html;
        
        document.querySelectorAll('.area-card:not(.locked)').forEach(card => {
            card.addEventListener('click', (e) => {
                if (inCombat) { addLog('Termine o combate primeiro.'); return; }
                let idx = parseInt(card.dataset.dungeon);
                let dungeon = dungeonInstances[idx];
                document.getElementById('promptDungeonName').innerText = dungeon.nome;
                document.getElementById('dungeonPrompt').classList.remove('hidden');
                document.getElementById('dungeonPrompt').dataset.dungeonIdx = idx;
            });
        });
    }

    document.getElementById('promptConfirm').addEventListener('click', () => {
        let idx = document.getElementById('dungeonPrompt').dataset.dungeonIdx;
        if (idx !== undefined) {
            dungeonInstances[idx].inimigos = gerarInimigosDungeon(idx);
            dungeonComplete = false;
            currentDungeonIdx = parseInt(idx);
            player.currentDungeonRank = dungeonInstances[currentDungeonIdx].rank;
            isTestRank = false;
            window.currentTestEnemy = null;
            
            if (player.companions.length > 0) {
                document.getElementById('companionStatus').classList.remove('hidden');
            }
            renderPotionButtons();
            document.getElementById('potionStatus').classList.remove('hidden');
            
            refreshUI();
        }
        document.getElementById('dungeonPrompt').classList.add('hidden');
    });

    document.getElementById('promptCancel').addEventListener('click', () => {
        document.getElementById('dungeonPrompt').classList.add('hidden');
    });

    function renderEnemies() {
        let enemyDiv = document.getElementById('enemyList');
        if (dungeonComplete) {
            enemyDiv.innerHTML = '<h4>üèÜ Masmorra conclu√≠da!</h4><p>Parab√©ns! Escolha outra masmorra ou reinicie esta.</p>';
        } else if (!isTestRank && currentDungeonIdx !== null) {
            let dungeon = dungeonInstances[currentDungeonIdx];
            let html = `<h4>${dungeon.nome}</h4>`;
            dungeon.inimigos.forEach((inv, idx) => {
                let bossTag = inv.isBoss ? ' üëë' : '';
                if (inv.vivo) {
                    html += `<div class="enemy-entry" data-dungeon="${currentDungeonIdx}" data-idx="${idx}">${inv.nome} (${inv.rank})${bossTag} ‚ù§Ô∏è${inv.hp}/${inv.maxHp}</div>`;
                } else {
                    html += `<div class="enemy-entry" style="opacity:0.5;" data-dungeon="${currentDungeonIdx}" data-idx="${idx}">üíÄ ${inv.nome}${bossTag} (derrotado)</div>`;
                }
            });
            enemyDiv.innerHTML = html;

            document.querySelectorAll('.enemy-entry').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (inCombat) { addLog('Voc√™ j√° est√° em combate!'); return; }
                    let dungeonIdx = parseInt(el.dataset.dungeon);
                    let idx = parseInt(el.dataset.idx);
                    let inimigo = dungeonInstances[dungeonIdx].inimigos[idx];
                    if (!inimigo.vivo) { addLog('Este inimigo j√° foi derrotado.'); return; }
                    currentDungeonIdx = dungeonIdx;
                    currentEnemyIndex = idx;
                    isTestRank = false;
                    inCombat = true;
                    recruitAttempts = 3;
                    document.getElementById('combatActions').classList.remove('hidden');
                    document.getElementById('shadowRecruit').classList.add('hidden');
                    addLog(`‚öîÔ∏è Combate iniciado contra ${inimigo.nome} (Rank ${inimigo.rank})`);
                });
            });
        } else if (isTestRank) {
            enemyDiv.innerHTML = '<h4>‚öîÔ∏è TESTE DE RANKING</h4><p>Voc√™ est√° em combate de teste. Finalize ou fuja.</p>';
        } else {
            enemyDiv.innerHTML = '<div style="text-align:center;">Selecione uma masmorra</div>';
        }
    }

    function refreshUI() {
        recalcularTotais();

        document.getElementById('statHp').innerText = player.hp;
        document.getElementById('statMaxHp').innerText = totalMaxHp;
        document.getElementById('statMana').innerText = totalMana;
        document.getElementById('statForca').innerText = totalForca;
        document.getElementById('statVit').innerText = totalMaxHp;
        document.getElementById('statPontos').innerText = player.pontosStatus;
        document.getElementById('statGemas').innerText = player.gems;
        document.getElementById('gemsDisplay').innerHTML = `üíé ${player.gems}`;
        
        let xpPercent = (player.xp / player.xpNext) * 100;
        document.getElementById('xpBarFill').style.width = xpPercent + '%';
        document.getElementById('xpText').innerText = `${player.xp}/${player.xpNext}`;

        let maxShadow = Math.floor(totalMana / 30);
        document.getElementById('maxShadow').innerText = maxShadow;
        document.getElementById('shadowCount').innerText = player.shadows.length;

        let sl = document.getElementById('shadowList');
        sl.innerHTML = '';
        player.shadows.forEach((s, idx) => {
            let bonus = getShadowBonus(s);
            let precoVenda = shadowBasePrice[s.rank] * s.level;
            let d = document.createElement('div');
            d.className = 'shadow-item';
            d.innerHTML = `
                <div class="shadow-info">
                    <span class="shadow-name">${s.nome} (${s.rank}) Lv.${s.level}</span>
                    <span class="shadow-bonus">+${bonus.forca}‚öîÔ∏è +${bonus.hp}‚ù§Ô∏è XP: ${s.xp}/${s.xpNext}</span>
                </div>
                <button class="btn-vender" data-index="${idx}">Vender (üíé${precoVenda})</button>
            `;
            sl.appendChild(d);
        });

        document.querySelectorAll('.btn-vender').forEach(btn => {
            btn.addEventListener('click', (e) => {
                let index = parseInt(e.target.dataset.index);
                venderSombra(index);
            });
        });

        renderDungeons();
        renderEnemies();
        renderActiveCompanions();
        
        if (player.companions.length > 0 && currentDungeonIdx !== null) {
            document.getElementById('companionStatus').classList.remove('hidden');
        } else {
            document.getElementById('companionStatus').classList.add('hidden');
        }

        renderPotionButtons();
        if (currentDungeonIdx !== null) {
            document.getElementById('potionStatus').classList.remove('hidden');
        } else {
            document.getElementById('potionStatus').classList.add('hidden');
        }

        if (player.pontosStatus > 0) {
            document.getElementById('levelUpActions').classList.remove('hidden');
        } else {
            document.getElementById('levelUpActions').classList.add('hidden');
        }

        renderShop();
        renderCompanionShop();
    }

    function renderShop() {
        let shopDiv = document.getElementById('shopPanel');
        let html = '';
        for (let slot in itemCatalog) {
            let slotNome = {
                cabeca: 'Cabe√ßa', maoD: 'M√£o D', maoE: 'M√£o E', tronco: 'Tronco', pernas: 'Pernas'
            }[slot];
            html += `<div class="equip-slot"><div class="slot-header">${slotNome}</div>`;
            itemCatalog[slot].forEach(item => {
                let equipado = player.equipment[slot] === item.id ? '‚úîÔ∏è' : '';
                let possui = player.inventario.includes(item.id);
                let textoBotao = '';
                if (equipado) {
                    textoBotao = 'Equipado';
                } else if (possui) {
                    textoBotao = 'Equipar';
                } else {
                    textoBotao = `Comprar (üíé${item.preco})`;
                }
                html += `<div class="item-row">
                    <span class="item-info">${item.nome} (HP:${item.hp||0} FOR:${item.forca||0} MAN:${item.mana||0})</span>
                    <button class="btn-equip" data-slot="${slot}" data-item-id="${item.id}">${textoBotao}</button>
                </div>`;
            });
            if (player.equipment[slot]) {
                html += `<div class="item-row">
                    <span class="item-info">Nenhum</span>
                    <button class="btn-equip" data-slot="${slot}" data-item-id="none">Remover</button>
                </div>`;
            }
            html += '</div>';
        }
        shopDiv.innerHTML = html;

        document.querySelectorAll('.btn-equip').forEach(btn => {
            btn.addEventListener('click', (e) => {
                let slot = e.target.dataset.slot;
                let itemId = e.target.dataset.itemId === 'none' ? null : e.target.dataset.itemId;
                equiparItem(slot, itemId);
            });
        });
    }

    function equiparItem(slot, itemId) {
        if (inCombat) { addLog('N√£o pode equipar durante combate.'); return; }

        if (itemId === null) {
            player.equipment[slot] = null;
            addLog(`Removeu equipamento do slot ${slot}.`);
            refreshUI();
            return;
        }

        let item = encontrarItemPorId(slot, itemId);
        if (!item) {
            addLog('Item inv√°lido.');
            return;
        }

        if (player.inventario.includes(itemId)) {
            player.equipment[slot] = itemId;
            addLog(`Equipou ${item.nome} no slot ${slot}.`);
        } else {
            if (player.gems < item.preco) {
                addLog('Gemas insuficientes!');
                return;
            }
            player.gems -= item.preco;
            player.inventario.push(itemId);
            player.equipment[slot] = itemId;
            addLog(`Comprou e equipou ${item.nome} no slot ${slot}.`);
        }

        refreshUI();
    }

    function venderSombra(index) {
        if (inCombat) {
            addLog('N√£o pode vender sombras durante combate.');
            return;
        }
        if (index < 0 || index >= player.shadows.length) return;
        let sombra = player.shadows[index];
        let preco = shadowBasePrice[sombra.rank] * sombra.level;
        player.gems += preco;
        player.shadows.splice(index, 1);
        addLog(`üí∞ Voc√™ vendeu ${sombra.nome} (Lv.${sombra.level}) por ${preco} gemas.`);
        refreshUI();
    }

    function atacar() {
        if (!inCombat) return;

        let inimigo;
        if (isTestRank) {
            if (!window.currentTestEnemy) return;
            inimigo = window.currentTestEnemy;
        } else {
            if (currentEnemyIndex === null || currentDungeonIdx === null) return;
            inimigo = dungeonInstances[currentDungeonIdx].inimigos[currentEnemyIndex];
        }

        if (!inimigo.vivo) { 
            inCombat = false; 
            if (!isTestRank) currentEnemyIndex = null;
            else window.currentTestEnemy = null;
            refreshUI(); 
            return; 
        }

        let dano = (totalForca * 2) + Math.floor(Math.random() * 5);
        inimigo.hp -= dano;
        addLog(`Voc√™ causou ${dano} de dano. ${inimigo.nome} HP: ${inimigo.hp}/${inimigo.maxHp}`);

        if (inimigo.hp <= 0) {
            inimigo.vivo = false;
            if (!isTestRank) {
                player.xp += inimigo.xp;
                player.gems += inimigo.gem;
                addLog(`üíÄ ${inimigo.nome} derrotado! +${inimigo.xp} XP, +${inimigo.gem} gemas.`);
                
                darXPSombras(inimigo.xp);
                
                while (player.xp >= player.xpNext) {
                    player.level++;
                    player.xp -= player.xpNext;
                    player.xpNext = Math.floor(player.xpNext * 1.5);
                    player.pontosStatus += 3;
                    addLog(`‚¨ÜÔ∏è Subiu para n√≠vel ${player.level}! Ganhou 3 pontos de status.`);
                }
                inCombat = false;
                document.getElementById('combatActions').classList.add('hidden');
                document.getElementById('shadowRecruit').classList.remove('hidden');
            } else {
                let rankAtual = player.rank;
                let proximoRank = obterProximoRank(rankAtual);
                if (proximoRank) {
                    player.rank = proximoRank;
                    addLog(`üéâ PARAB√âNS! Voc√™ subiu para o Rank ${proximoRank}!`);
                } else {
                    addLog(`Voc√™ j√° √© Rank S+, n√£o pode subir mais.`);
                }
                inCombat = false;
                isTestRank = false;
                window.currentTestEnemy = null;
                document.getElementById('combatActions').classList.add('hidden');
                document.getElementById('shadowRecruit').classList.add('hidden');
            }
            if (!isTestRank && currentDungeonIdx !== null) {
                regenerarDungeonSeNecessario(currentDungeonIdx);
            }
            refreshUI();
            return;
        }

        let danoInimigo = inimigo.forca + Math.floor(Math.random() * 4);
        player.hp -= danoInimigo;
        addLog(`üòñ ${inimigo.nome} causou ${danoInimigo} de dano. Seu HP: ${player.hp}/${totalMaxHp}`);

        if (player.hp <= 0) {
            aplicarPenalidadeMorte();
            inCombat = false;
            if (isTestRank) {
                isTestRank = false;
                window.currentTestEnemy = null;
            } else {
                currentEnemyIndex = null;
            }
            refreshUI();
            return;
        }
        refreshUI();
    }

    function obterProximoRank(rank) {
        const ranks = ['E', 'D', 'C', 'B', 'A', 'S', 'S+'];
        let idx = ranks.indexOf(rank);
        if (idx >= 0 && idx < ranks.length-1) return ranks[idx+1];
        return null;
    }

    function fugir() {
        if (!inCombat) return;
        aplicarPenalidadeFuga();
        inCombat = false;
        if (isTestRank) {
            isTestRank = false;
            window.currentTestEnemy = null;
        } else {
            currentEnemyIndex = null;
        }
        document.getElementById('combatActions').classList.add('hidden');
        refreshUI();
    }

    function tentarSombra() {
        if (recruitAttempts <= 0) return;
        if (currentDungeonIdx === null || currentEnemyIndex === null) return;
        let inimigo = dungeonInstances[currentDungeonIdx].inimigos[currentEnemyIndex];
        if (!inimigo || inimigo.vivo) return;

        let maxShadow = Math.floor(totalMana / 30);
        if (player.shadows.length >= maxShadow) {
            addLog('Voc√™ atingiu o limite de sombras! Aumente sua Mana para invocar mais.');
            document.getElementById('shadowRecruit').classList.add('hidden');
            currentEnemyIndex = null;
            refreshUI();
            return;
        }

        let rankVal = { 'E':1, 'D':5, 'C':25, 'B':125, 'A':625, 'S':3125, 'S+':15625 };
        let playerRankVal = rankVal[player.rank] || 1;
        let inimigoRankVal = rankVal[inimigo.rank] || 1;
        let chance = 0.3 + (playerRankVal - inimigoRankVal) * 0.1;
        chance = Math.min(0.9, Math.max(0.2, chance));

        if (Math.random() < chance) {
            let novaSombra = {
                nome: inimigo.nome,
                rank: inimigo.rank,
                level: 1,
                xp: 0,
                xpNext: 100
            };
            player.shadows.push(novaSombra);
            addLog(`‚ú® Sucesso! ${inimigo.nome} se tornou sua sombra (Nv.1).`);
            document.getElementById('shadowRecruit').classList.add('hidden');
            currentEnemyIndex = null;
        } else {
            recruitAttempts--;
            addLog(`Falha ao tornar sombra. Tentativas restantes: ${recruitAttempts}`);
            if (recruitAttempts <= 0) {
                document.getElementById('shadowRecruit').classList.add('hidden');
                currentEnemyIndex = null;
            }
        }
        refreshUI();
    }

    function eliminar() {
        addLog('Voc√™ eliminou a sombra.');
        document.getElementById('shadowRecruit').classList.add('hidden');
        currentEnemyIndex = null;
        refreshUI();
    }

    function iniciarTesteRank() {
        if (inCombat) {
            addLog('Voc√™ j√° est√° em combate!');
            return;
        }
        let proximoRank = obterProximoRank(player.rank);
        if (!proximoRank) {
            addLog('Voc√™ j√° √© Rank S+, n√£o pode testar mais.');
            return;
        }
        let rank = proximoRank;
        let mult = rankMultiplier[rank];
        let nome = `Guardi√£o Rank ${rank}`;
        let hp = 50 * mult;
        let forca = 10 * mult;
        let xp = 0;
        let gem = 0;
        let inimigoTeste = {
            nome,
            rank,
            hp,
            maxHp: hp,
            forca,
            xp,
            gem,
            vivo: true
        };
        window.currentTestEnemy = inimigoTeste;
        isTestRank = true;
        inCombat = true;
        currentDungeonIdx = null;
        currentEnemyIndex = null;
        document.getElementById('combatActions').classList.remove('hidden');
        document.getElementById('shadowRecruit').classList.add('hidden');
        addLog(`‚öîÔ∏è Teste de Ranking: enfrente ${inimigoTeste.nome} (Rank ${rank}) para subir de n√≠vel!`);
        refreshUI();
    }

    function addStat(stat) {
        if (player.pontosStatus <= 0) return;
        player.pontosStatus--;
        if (stat === 'forca') player.base.forca += 2;
        else if (stat === 'mana') player.base.mana += 1;
        else if (stat === 'vida') { player.base.maxHp += 10; player.hp += 10; }
        refreshUI();
    }

    // Event listeners
    document.getElementById('btnSurgirInicial').addEventListener('click', () => {
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('creationScreen').classList.remove('hidden');
    });

    document.getElementById('btnIniciarJogo').addEventListener('click', () => {
        let nome = document.getElementById('playerName').value.trim();
        if (nome === '') {
            alert('Por favor, digite o nome do ca√ßador!');
            return;
        }
        player.name = nome;
        document.getElementById('creationScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.remove('hidden');
        addLog(`Bem-vindo, Ca√ßador ${player.name}.`);
        refreshUI();
    });

    document.querySelectorAll('.shop-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.shop-panel').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            let shopId = tab.dataset.shop;
            if (shopId === 'equip') document.getElementById('shopEquip').classList.add('active');
            else if (shopId === 'companion') document.getElementById('shopCompanion').classList.add('active');
            else if (shopId === 'potion') document.getElementById('shopPotion').classList.add('active');
            else if (shopId === 'gemshop') document.getElementById('shopGems').classList.add('active');
        });
    });

    document.querySelectorAll('.btn-comprar-pocao').forEach(btn => {
        btn.addEventListener('click', (e) => {
            let tipo = e.target.dataset.tipo;
            comprarPocao(tipo);
        });
    });

    // Event listeners para os bot√µes de compra de gemas
    document.querySelectorAll('.btn-comprar-gemas').forEach(btn => {
        btn.addEventListener('click', (e) => {
            let gemas = parseInt(e.target.dataset.gemas);
            let preco = parseFloat(e.target.dataset.preco);
            comprarGemas(gemas, preco);
        });
    });

    document.getElementById('btnAtacar').addEventListener('click', atacar);
    document.getElementById('btnFugir').addEventListener('click', fugir);
    document.getElementById('btnTornarSombra').addEventListener('click', tentarSombra);
    document.getElementById('btnEliminar').addEventListener('click', eliminar);
    document.getElementById('btnForca').addEventListener('click', () => addStat('forca'));
    document.getElementById('btnMana').addEventListener('click', () => addStat('mana'));
    document.getElementById('btnVida').addEventListener('click', () => addStat('vida'));
    document.getElementById('btnSubirRanking').addEventListener('click', iniciarTesteRank);

    // Bot√£o Loja de Gemas (abre a aba correspondente)
    document.getElementById('btnLojaGemas').addEventListener('click', () => {
        // Ativar a aba de gemas
        document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.shop-panel').forEach(p => p.classList.remove('active'));
        document.querySelector('[data-shop="gemshop"]').classList.add('active');
        document.getElementById('shopGems').classList.add('active');
    });

    setInterval(refreshUI, 200);
    refreshUI();
})();
</script>
</body>
</html>